# Update CMOR CVs table workflow.
# Intended to be triggered by `/update-cmor-cvs-table`
# in a pull request comment
# via `slash-command-dispatch.yaml`.
name: Update CMOR CVs table

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'The repository from which the slash command was dispatched'
        required: true
      comment-id:
        description: 'The comment-id of the slash command'
        required: true
      comment-pr-number:
        description: 'The number of the pull request of the slash command'
        required: true
      universe-cvs-fork:
        description: 'The fork to use when retrieving the universe CVs'
        required: true
      universe-cvs-branch:
        description: 'The branch to use when retrieving the universe CVs'
        required: true
      esgvoc-fork:
        description: 'The fork to use when installing esgvoc'
        required: true
      esgvoc-commit:
        description: 'The commit (ID) to use when installing esgvoc'
        required: true

jobs:
  update-cmor-cvs-table:
    runs-on: ubuntu-latest
    steps:
      - name: Add reaction
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          repository: ${{ github.event.inputs.repository }}
          comment-id: ${{ github.event.inputs.comment-id }}
          reactions: rocket

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"

      - name: Checkout branch
        env:
          GITHUB_TOKEN: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
        run: gh pr checkout ${{ github.event.inputs.comment-pr-number }}

      - name: Debug
        env:
          BRANCH: ${{ github.ref_name }}
        run: |
          echo "DEBUG"
          echo ${{ github.event.inputs.universe-cvs-fork }}
          echo ${{ github.event.inputs.universe-cvs-branch }}
          echo ${{ github.event.inputs.esgvoc-fork }}
          echo ${{ github.event.inputs.esgvoc-commit }}

      # - name: Set up environment
      #   run: |
      #     # TODO: put esgvoc version into requirements file if needed
      #     pip install -r requirements-cmor-cvs-table.txt
      #
      #     esgvoc config remove-project -f cmip7 || true
      #     # TODO: put these values into some other file so that is committed too
      #     esgvoc config set "universe:github_repo=https://github.com/$UNIVERSE_CVS_FORK/WCRP-universe" "universe:branch=$UNIVERSE_CVS_BRANCH"
      #     esgvoc config add-project cmip7 --custom --repo "https://github.com/$CMIP7_CVS_FORK/CMIP7-CVs" --branch "$CMIP7_CVS_BRANCH"
      #     esgvoc config remove-project -f cmip6 || true
      #     esgvoc config remove-project -f cmip6plus || true
      #
      #     esgvoc install
      #
      # - name: Update cmor-cvs.json
      #   run: |
      #     esgvoc cmor-export-cvs-table --out-path cmor-cvs.json
      #
      #     git add cmor-cvs.json
      #     git config --local user.email "ci-runner@cmip7-cvs.invalid"
      #     git config --local user.name "$GITHUB_ACTOR"
      #     git commit -m "Update CMOR CVs file"
      #     git push
      #
      - name: Add reaction
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          repository: ${{ github.event.inputs.repository }}
          comment-id: ${{ github.event.inputs.comment-id }}
          reactions: hooray
